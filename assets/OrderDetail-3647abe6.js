import{m as g,l as $,o as x,a as l,n as i,d as r,e as M,b as m,p as G,y as o,c as f,s as n,_ as w,N as h,B as F,E as Q,$ as j,a0 as J,v as y,D as K}from"./.pnpm-ef8d297c.js";import{a as W,h as q,b as z,c as H,d as X,e as Y,f as Z}from"./index-1718fef5.js";import{_ as ee}from"./index-f8813b5b.js";import"./index-95c6f037.js";const ae={class:"btn-area"},te={key:0},se={key:1,style:{"flex-direction":"row"}},ne={key:2},le={key:4},oe={key:6},re={key:7},ue={key:8},ie={__name:"OrderDetail",setup(de){const d=g(""),D=$(),a=g({}),u=new Map;u.set("ORDER_FORCE_CLOSED","订单强制结束"),u.set("PRE_ORDER_REQUEST_SUBMITTED","订单已提交"),u.set("PRE_ORDER_REQUEST_PASSED","订单已通过"),u.set("PRE_DEPARTURE_USER_CANCELLED","订单已被用户取消"),u.set("DRIVING_USER_CONFIRM_DEPARTURE","用户确认发车"),u.set("ARRIVED_USER_UNPAID","用户未支付"),u.set("PAID_WAITING_CALLBACK","已支付，等待回调"),u.set("ORDER_NORMAL_CLOSED","订单正常结束");const c=async()=>{const t=await W(d.value);t!==null&&t.code===2e3?a.value=t.result.result:t!==null?n({type:"danger",message:`加载订单具体信息失败,${t.msg}`}):n({type:"danger",message:"加载订单具体信息失败,请检查网络连接"})},E=g(""),R=g(0);x(async()=>{d.value=D.currentRoute.value.query.orderId,await c(),E.value=JSON.parse(a.value.passingPoint).join(" "),document.getElementById("van-tab")!==null&&document.getElementById("van-tab").remove(),R.value=a.value.score===0?1:a.value.score});const O=async()=>{const t=[];a.value.passingPoint!==""&&t.push(JSON.parse(a.value.passingPoint)),window.location.href="#/main/driver/preview-map?departurePoint="+a.value.departurePoint+"&arrivePoint="+a.value.arrivePoint+"&passingPoint="+a.value.passingPoint+"&fromUrl=/main/carpooling/passenger-order"},C=async()=>{const t=await X(d.value);t!==null&&t.code===2e3?(n({type:"success",message:"确认发车成功"}),await c()):t!==null?n({type:"danger",message:`确认发车失败,${t.msg}`}):n({type:"danger",message:"确认发车失败,请检查网络连接"})},P=async()=>{const t=new Date,e=new Date(a.value.departureTime);e.getTime()-t.getTime()>36e5||t.getTime()-e.getTime()>36e5?w({title:"提示",message:"当前时间与出发时间相差较大,是否确认发车",confirmButtonText:"确认发车",cancelButtonText:"取消",confirmButtonColor:"#f00",showCancelButton:!0}).then(async()=>{await C()}).catch(()=>{n({type:"primary",message:"您已放弃确认发车"})}):await C()},A=async()=>{const t=await Y();if(t!==null&&t.code===2e3){const e=t.result.userCancelTimes;if(e>=3)w({title:"提示",message:`您本年度已经取消了${e}次订单,本次若强制取消订单将会直接进入收费流程`,confirmButtonText:"确认取消",cancelButtonText:"取消",confirmButtonColor:"#f00",showCancelButton:!0}).then(()=>!0).catch(()=>(n({type:"warning",message:"您已放弃取消订单"}),!1));else if(e!==0)return n({type:"warning",message:`您在半年内一共取消了${e}次订单,本次可直接取消`}),!0;return!0}else if(t!==null)return n({type:"danger",message:`获取取消次数失败,${t.msg}`}),!1;return n({type:"danger",message:"获取取消次数失败,请检查网络连接"}),!1},T=async t=>{const e=await Z(t);e!==null&&e.code===2e3?(n({type:"success",message:"取消订单成功"}),await c()):e!==null?n({type:"danger",message:`取消订单失败,${e.msg}`}):n({type:"danger",message:"取消订单失败,请检查网络连接"})},S=async()=>{await A()&&await T(d.value)},V=async()=>{const t=await q(d.value);t!==null&&t.code===2e3?(n({type:"success",message:"确认到达成功"}),await c()):t!==null?n({type:"danger",message:`确认到达失败,${t.msg}`}):n({type:"danger",message:"确认到达失败,请检查网络连接"})},v=g(!1),U=async t=>{if(t.name==="支付宝支付")try{const e=await z(d.value);e!==null&&e.code===2e3?(v.value=!1,document.write(e.payUrl)):e!==null?n({type:"danger",message:`支付失败,${e.msg}`}):n({type:"danger",message:"支付失败,请检查网络连接"})}catch(e){console.log(e)}finally{v.value=!1,await c()}else n({type:"danger",message:"暂不支持该支付方式"})},I=[{name:"支付宝支付"}],N=async()=>{const t={score:R.value},e=H(d.value,t);e!==null&&e.code===2e3?(n({type:"success",message:"评分成功"}),await c()):e!==null?n({type:"danger",message:`评分失败,${e.msg}`}):n({type:"danger",message:"评分失败,请检查网络连接"})};return(t,e)=>{const k=h,p=K,_=F,B=Q,L=j,b=J;return l(),i("div",null,[r(k,{title:"订单详情","left-text":"返回","left-arrow":"",onClickLeft:e[0]||(e[0]=s=>M(D).go(-1))}),r(B,{inset:""},{default:m(()=>[r(p,{readonly:"",modelValue:a.value.departurePoint,"onUpdate:modelValue":e[1]||(e[1]=s=>a.value.departurePoint=s),name:"出发地",label:"出发地"},null,8,["modelValue"]),r(p,{readonly:"",modelValue:a.value.arrivePoint,"onUpdate:modelValue":e[2]||(e[2]=s=>a.value.arrivePoint=s),name:"到达地",label:"到达地"},null,8,["modelValue"]),r(p,{readonly:"",modelValue:E.value,"onUpdate:modelValue":e[3]||(e[3]=s=>E.value=s),name:"途径地",label:"途径地"},null,8,["modelValue"]),r(_,{plain:"",block:"",type:"primary",size:"small",style:{width:"40%",margin:"2% auto"},onClick:e[4]||(e[4]=s=>O())},{default:m(()=>[y(" 预览行程路线 ")]),_:1}),r(p,{readonly:"",modelValue:a.value.departureTime,"onUpdate:modelValue":e[5]||(e[5]=s=>a.value.departureTime=s),name:"出发时间",label:"出发时间"},null,8,["modelValue"]),r(p,{readonly:"",modelValue:a.value.arriveTime,"onUpdate:modelValue":e[6]||(e[6]=s=>a.value.arriveTime=s),name:"到达时间",label:"到达时间"},null,8,["modelValue"]),a.value.status==="ORDER_NORMAL_CLOSED"?(l(),f(p,{key:0,readonly:"",modelValue:a.value.score,"onUpdate:modelValue":e[7]||(e[7]=s=>a.value.score=s),name:"行程评分",label:"本次行程评分"},null,8,["modelValue"])):o("",!0)]),_:1}),G("div",ae,[a.value.status==="PRE_ORDER_REQUEST_SUBMITTED"?(l(),i("div",te,"正在等待司机确认")):o("",!0),a.value.status==="PRE_ORDER_REQUEST_PASSED"?(l(),i("div",se,[r(_,{plain:"",type:"success",onClick:e[8]||(e[8]=s=>P())},{default:m(()=>[y(" 确认发车 ")]),_:1}),r(_,{plain:"",type:"danger",onClick:e[9]||(e[9]=s=>S())},{default:m(()=>[y(" 取消行程 ")]),_:1})])):o("",!0),a.value.status==="PRE_DEPARTURE_USER_CANCELLED"?(l(),i("div",ne,"订单已被用户取消")):o("",!0),a.value.status==="DRIVING_USER_CONFIRM_DEPARTURE"?(l(),f(_,{key:3,plain:"",type:"success",onClick:e[10]||(e[10]=s=>V())},{default:m(()=>[y(" 确认到达 ")]),_:1})):o("",!0),a.value.status==="ARRIVED_USER_UNPAID"?(l(),i("div",le,"请您支付订单")):o("",!0),a.value.status==="ARRIVED_USER_UNPAID"?(l(),f(_,{key:5,plain:"",onClick:e[11]||(e[11]=s=>v.value=!0),type:"success"},{default:m(()=>[y(" 开始支付 ")]),_:1})):o("",!0),a.value.status==="PAID_WAITING_CALLBACK"?(l(),i("div",oe,"已发起支付，正在等待回调")):o("",!0),a.value.status==="ORDER_NORMAL_CLOSED"&&a.value.score===0?(l(),i("div",re," 订单正常结束,请问本次行程评分 ")):o("",!0),a.value.status==="ORDER_NORMAL_CLOSED"&&a.value.score!==0?(l(),i("div",ue," 订单正常结束 ")):o("",!0),a.value.status==="ORDER_NORMAL_CLOSED"?(l(),f(L,{key:9,modelValue:R.value,"onUpdate:modelValue":e[12]||(e[12]=s=>R.value=s),color:"#ffd21e","void-icon":"star"},null,8,["modelValue"])):o("",!0),a.value.status==="ORDER_NORMAL_CLOSED"&&a.value.score===0?(l(),f(_,{key:10,plain:"",onClick:e[13]||(e[13]=s=>N())},{default:m(()=>[y(" 确认提交评分 ")]),_:1})):o("",!0)]),r(b,{show:v.value,"onUpdate:show":e[14]||(e[14]=s=>v.value=s),actions:I,"cancel-text":"取消","close-on-click-action":"",onCancel:e[15]||(e[15]=s=>v.value=!1),description:"请选择支付方式",onSelect:U},null,8,["show"])])}}},_e=ee(ie,[["__scopeId","data-v-4f4b5a67"]]);export{_e as default};
