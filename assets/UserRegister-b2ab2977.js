import{G as ce,m as f,l as ve,H as me,w as pe,o as ge,J as fe,a as d,n as Y,d as c,e as w,b as n,q as y,s as l,t as k,N as ye,F as ke,c as o,v as g,y as u,p as N,z as be,A as he,D as De,B as Ce,K as Ve,L as _e,U as xe,E as we}from"./.pnpm-ef8d297c.js";import{v as O,b as Z,a as Ne,c as Pe}from"./validatorUtil-fa8d24ca.js";import{_ as I}from"./index-95c6f037.js";import{s as H,a as $e,b as K}from"./ocrUtil-8520b5a1.js";import{e as Ie}from"./jsencrypt-4aaa3cff.js";import{_ as Ee}from"./index-f8813b5b.js";const Se=ce("registerDtoCache",()=>({registerCache:f({registerDto:{username:"",password:"",email:"",isDriver:!1,isPassenger:!1,driversPersonalId:"",driversName:"",driversLicenseNo:"",driversLicenseType:"",driversPlateNo:"",driversVehicleType:"",driversExpireDate:""},checkSmsDisabled:!1,checkMailDisabled:!1,checkIdFront:!1,checkIdBack:!1,checkDriving:!1,checkCarFront:!1,checkCarBack:!1})}),{persist:{storage:sessionStorage,paths:["registerCache"],key:"registerCache"}});const G=P=>(be("data-v-903e8566"),P=P(),he(),P),ze={class:"register-form"},Le=G(()=>N("h3",{class:"title"},"西工大拼车平台——注册",-1)),Te=G(()=>N("h5",null,"用户角色选择(可多选)",-1)),Ue={key:4},Be=G(()=>N("a",null,"您确认注册则代表您认可我们的",-1)),Re={class:"submit-login-btn"},Fe={__name:"UserRegister",setup(P){const R=ve(),j=Se(),{registerCache:p}=me(j),a=f({username:"",password:"",email:"",isDriver:!1,isPassenger:!1,driversPersonalId:"",driversName:"",driversLicenseNo:"",driversLicenseType:"",driversPlateNo:"",driversVehicleType:"",driversExpireDate:""}),E=f(!0),_=f({phone:"",code:""}),F=f(""),Q=async()=>{if(!O(a.value.username)){l({type:"danger",message:"手机号格式不正确"});return}y({duration:0,forbidClick:!0,message:"请求验证码发送中"});const s={phone:a.value.username};try{const{data:e}=await I.post("/api/auth/sendsms",s);if(e.code!==null&&e.code===2e3){l({type:"success",message:"验证码已发送"}),F.value="300s",E.value=!1;let t=300;const i=setInterval(()=>{t--,F.value=t+"s",t===0&&(clearInterval(i),E.value=!0)},1e3)}else l({type:"danger",message:`验证码发送失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{k()}},h=f(!1),W=async()=>{if(_.value.phone=a.value.username,!Z(_.value.code)||!O(_.value.phone)){l({type:"danger",message:"格式不正确"});return}y({duration:0,forbidClick:!0,message:"请求验证码验证中"});try{const{data:s}=await I.post("/api/auth/checksms",_.value);s.code!==null&&s.code===2e3?(l({type:"success",message:"验证码验证成功"}),h.value=!0):l({type:"danger",message:`验证码验证失败,${s.msg},请重试`})}catch(s){l({type:"danger",message:`服务器异常${s},请通知管理员`})}finally{k()}},x=f({mail:"",code:""}),D=f(!1),S=f(!0),M=f(""),X=async()=>{if(!/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(a.value.email)){l({type:"danger",message:"邮箱格式不正确"});return}y({duration:0,forbidClick:!0,message:"请求验证码发送中"});const s={email:a.value.email};try{const{data:e}=await I.post("/api/auth/sendmail",s);if(e.code!==null&&e.code===2e3){l({type:"success",message:"验证码已发送"}),M.value="300s",S.value=!1;let t=300;const i=setInterval(()=>{t--,M.value=t+"s",t===0&&(clearInterval(i),S.value=!1)},1e3)}else l({type:"danger",message:`验证码发送失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{k()}},ee=async()=>{if(x.value.mail=a.value.email,!Z(x.value.code)||/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(x.value.code)){l({type:"danger",message:"格式不正确"});return}y({duration:0,forbidClick:!0,message:"请求邮箱验证中"});try{const{data:s}=await I.post("/api/auth/checkmail",x.value);s.code!==null&&s.code===2e3?(l({type:"success",message:"邮箱验证成功"}),D.value=!0):l({type:"danger",message:`邮箱验证失败,${s.msg},请重试`})}catch(s){l({type:"danger",message:`服务器异常${s},请通知管理员`})}finally{k()}},C=f([]),v=f(!1);let z=!1,L=!1,T=!1,U=!1,B=!1;const $=s=>s.content.size>10*1024*1024?(l({type:"danger",message:"文件大小不能超过10M"}),!1):/image\/(png|jpg|jpeg|JPG|PNG)/.test(s.file.type)?!0:(l({type:"danger",message:"文件格式不正确"}),!1),ae=async s=>{if($(s)){y({duration:0,forbidClick:!0,message:"正在识别身份证"});try{const{data:e}=await H(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.face!==null){const i=t.data.face;if(i.warning.isCopy!==0||i.warning.isReshoot!==0){l({type:"danger",message:"识别到翻拍或复制。请识别原件身份证"});return}a.value.driversName=i.data.name,a.value.driversPersonalId=i.data.idNumber,z=!0}else l({type:"danger",message:"身份证识别失败,请重试"})}else l({type:"danger",message:`身份证识别失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{k()}}},se=async s=>{if($(s)){y({duration:0,forbidClick:!0,message:"正在识别身份证"});try{const{data:e}=await H(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.back!==null){const i=t.data.back;if(i.warning.isCopy!==0||i.warning.isReshoot!==0){l({type:"danger",message:"识别到翻拍或复制。请识别原件身份证"});return}i.data.validPeriod.split("-")[1]==="长期"?i.data.validPeriod="2999-12-31":a.value.driversExpireDate=i.data.validPeriod.split("-")[1].replace(/(\d{4})\.(\d{2})\.(\d{2})/,"$1-$2-$3"),L=!0}else l({type:"danger",message:"请识别身份证反面"})}else l({type:"danger",message:`身份证识别失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{k()}}},le=async s=>{if($(s))a.value.driversName===""&&l({type:"danger",message:"请先识别身份证信息"});else return;y({duration:0,forbidClick:!0,message:"正在识别驾驶证"});try{const{data:e}=await $e(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.face!==null){if(t.data.face.data.name!==a.value.driversName||t.data.face.data.licenseNumber!==a.value.driversPersonalId){l({type:"danger",message:"驾驶证与身份证所属人不一致,请更新材料"});return}a.value.driversLicenseNo=t.data.face.data.licenseNumber,a.value.driversLicenseType=t.data.face.data.approvedType;const i=t.data.face.data.validPeriod.split("至")[1];a.value.driversExpireDate===""?a.value.driversExpireDate=i:a.value.driversExpireDate=a.value.driversExpireDate>i?i:a.value.driversExpireDate,T=!0}else l({type:"danger",message:"驾驶证识别失败,请重试"})}else l({type:"danger",message:`驾驶证识别失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{k()}},re=async s=>{if($(s)){y({duration:0,forbidClick:!0,message:"正在识别行驶证"});try{const{data:e}=await K(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.face!==null){if(t.data.face.data.owner!==a.value.driversName){l({type:"danger",message:"行驶证与身份证所属人不一致或身份信息为空,请更新材料"});return}else t.data.face.data.useNature!=="非营运"&&l({type:"warning",message:"行驶证非营运,我们建议您更新材料"});a.value.driversPlateNo=t.data.face.data.licensePlateNumber,a.value.driversVehicleType=t.data.face.data.model+" "+t.data.face.data.vehicleType,U=!0}}else l({type:"danger",message:"行驶证识别失败,请重试"})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{k()}}},te=async s=>{if($(s)){y({duration:0,forbidClick:!0,message:"正在识别行驶证"});try{const{data:e}=await K(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.back!==null){if(t.data.back.data.inspectionRecord===null){l({type:"danger",message:"行驶证未年检,请更新材料"});return}const i=t.data.back.data.inspectionRecord,m=/有效期至(\d{1,4}年\d{1,2}月)/g,V=i.match(m);if(V===null){l({type:"danger",message:"行驶证年检信息解析失败,请更新材料"});return}V.sort((A,J)=>{const r=A.match(/\d{1,4}年\d{1,2}月/)[0],ue=J.match(/\d{1,4}年\d{1,2}月/)[0];return r>ue?1:-1});const b=V[V.length-1].match(/\d{1,4}年\d{1,2}月/)[0].replace("年","-").replace("月","-01");a.value.driversExpireDate===""?a.value.driversExpireDate=b:a.value.driversExpireDate=a.value.driversExpireDate>b?b:a.value.driversExpireDate,B=!0}}else l({type:"danger",message:"行驶证识别失败,请重试"})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{k()}}};pe(C,s=>{v.value=!!s.includes("isDriver")});const ie=()=>a.value.driversName===""||a.value.driversPersonalId===""||a.value.driversVehicleType===""||a.value.driversExpireDate===""||a.value.driversPlateNo==="",de=()=>!z||!L||!T||!U||!B,ne=()=>a.value.isDriver&&ie()?(l({type:"danger",message:"请完善司机信息"}),!1):h.value?!D.value&&a.value.email!==""?(l({type:"danger",message:"请先完成邮箱校验"}),!1):a.value.isDriver&&de()?(l({type:"danger",message:"请先有关证照校验"}),!1):!0:(l({type:"danger",message:"请先完成手机号校验"}),!1),oe=async()=>{y({duration:0,forbidClick:!0,message:"正在提交注册信息,我们推荐您完成注册后及时绑定支付宝。"});try{if(C.value.indexOf("isDriver")!==-1?a.value.isDriver=!0:C.value.indexOf("isPassenger")!==-1&&(a.value.isPassenger=!0),!a.value.isDriver&&!a.value.isPassenger){l({type:"danger",message:"请选择用户角色"});return}if(!ne())return;a.value.password=Ie(a.value.password);const{data:s}=await I.post("/api/auth/register/user",a.value);s.code===2e3?(l({type:"success",message:"注册成功,请您登录"}),await R.push("/login")):l({type:"danger",message:s.message})}catch(s){l({type:"danger",message:`服务器异常${s},请通知管理员`})}finally{k()}};return ge(()=>{(p.value.registerDto.isDriver||p.value.registerDto.isPassenger||p.value.registerDto.username!=="")&&(a.value=p.value.registerDto,h.value=p.value.checkSmsDisabled,D.value=p.value.checkMailDisabled,z=p.value.checkIdFront,L=p.value.checkIdBack,T=p.value.checkDriving,U=p.value.checkCarFront,B=p.value.checkCarBack,p.value.registerDto.isDriver&&C.value.push("isDriver"),p.value.registerDto.isPassenger&&C.value.push("isPassenger"))}),fe(()=>{j.$patch(s=>{s.registerCache.registerDto=a.value,s.registerCache.checkSmsDisabled=h.value,s.registerCache.checkMailDisabled=D.value,s.registerCache.checkIdFront=z,s.registerCache.checkIdBack=L,s.registerCache.checkDriving=T,s.registerCache.checkCarFront=U,s.registerCache.checkCarBack=B})}),(s,e)=>{const t=ye,i=De,m=Ce,V=Ve,q=_e,b=xe,A=we,J=ke;return d(),Y("div",ze,[c(t,{title:"注册","left-text":"返回","left-arrow":"",onClickLeft:e[0]||(e[0]=r=>w(R).go(-1))}),Le,c(J,{onSubmit:e[19]||(e[19]=r=>oe())},{default:n(()=>[c(A,{inset:"",style:{padding:"1%"}},{default:n(()=>[c(i,{modelValue:a.value.username,"onUpdate:modelValue":e[1]||(e[1]=r=>a.value.username=r),name:"手机号",label:"手机号",placeholder:"请输入手机号",type:"tel",clearable:"",rules:[{validator:w(O),message:"请输入正确的手机号码"}],disabled:h.value},null,8,["modelValue","rules","disabled"]),h.value?u("",!0):(d(),o(i,{key:0,modelValue:_.value.code,"onUpdate:modelValue":e[3]||(e[3]=r=>_.value.code=r),center:"",clearable:"",type:"digit",label:"短信验证码",placeholder:"请输入验证码",rules:[{validator:w(Z),message:"应为4位数字"}]},{button:n(()=>[E.value?(d(),o(m,{key:0,size:"small",type:"primary",onClick:e[2]||(e[2]=r=>Q()),disabled:h.value},{default:n(()=>[g(" 发送验证码 ")]),_:1},8,["disabled"])):E.value?u("",!0):(d(),o(m,{key:1,size:"small",type:"primary",disabled:"",loading:"","loading-text":F.value},null,8,["loading-text"]))]),_:1},8,["modelValue","rules"])),h.value?u("",!0):(d(),o(m,{key:1,plain:"",block:"",type:"primary",size:"small",style:{width:"40%",margin:"1% auto"},onClick:e[4]||(e[4]=r=>W())},{default:n(()=>[g("验证手机号码")]),_:1})),c(i,{modelValue:a.value.password,"onUpdate:modelValue":e[5]||(e[5]=r=>a.value.password=r),name:"密码",label:"密码",type:"password",placeholder:"请设置密码",autocomplete:"off",rules:[{validator:w(Ne),message:"应为4-16位数字/字母/下划线"}]},null,8,["modelValue","rules"]),c(i,{modelValue:a.value.email,"onUpdate:modelValue":e[6]||(e[6]=r=>a.value.email=r),center:"",clearable:"",label:"邮箱",placeholder:"请输入邮箱(非强制)",disabled:D.value},null,8,["modelValue","disabled"]),D.value?u("",!0):(d(),o(i,{key:2,modelValue:x.value.code,"onUpdate:modelValue":e[8]||(e[8]=r=>x.value.code=r),center:"",clearable:"",type:"digit",label:"邮箱验证码",placeholder:"请输入验证码",rules:[{required:!1,validator:w(Pe),message:"应为4位数字"}]},{button:n(()=>[S.value?(d(),o(m,{key:0,size:"small",type:"primary",onClick:e[7]||(e[7]=r=>X())},{default:n(()=>[g(" 发送验证码 ")]),_:1})):S.value?u("",!0):(d(),o(m,{key:1,size:"small",type:"primary",disabled:"",loading:"","loading-text":M.value},null,8,["loading-text"]))]),_:1},8,["modelValue","rules"])),D.value?u("",!0):(d(),o(m,{key:3,plain:"",block:"",type:"primary",size:"small",style:{width:"40%",margin:"1% auto"},onClick:e[9]||(e[9]=r=>ee())},{default:n(()=>[g("验证邮箱")]),_:1})),Te,c(q,{modelValue:C.value,"onUpdate:modelValue":e[10]||(e[10]=r=>C.value=r),direction:"horizontal",class:"checkbox-area"},{default:n(()=>[c(V,{name:"isPassenger"},{default:n(()=>[g("我希望拼车-乘客")]),_:1}),c(V,{name:"isDriver"},{default:n(()=>[g("我可以搭人-司机")]),_:1})]),_:1},8,["modelValue"]),v.value?(d(),Y("h5",Ue,"请您点击按钮，通过图片识别填入以下信息")):u("",!0),v.value?(d(),o(b,{key:5,style:{width:"60%",margin:"0 auto"},"after-read":ae},{default:n(()=>[c(m,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[g(" 拍摄您的身份证-正面-以自动识别 ")]),_:1})]),_:1})):u("",!0),v.value?(d(),o(b,{key:6,style:{width:"60%",margin:"1% auto"},"after-read":se},{default:n(()=>[c(m,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[g(" 拍摄您的身份证-背面-以自动识别 ")]),_:1})]),_:1})):u("",!0),v.value?(d(),o(i,{key:7,modelValue:a.value.driversPersonalId,"onUpdate:modelValue":e[11]||(e[11]=r=>a.value.driversPersonalId=r),center:"",disabled:"",clearable:"",label:"身份证号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),v.value?(d(),o(i,{key:8,modelValue:a.value.driversName,"onUpdate:modelValue":e[12]||(e[12]=r=>a.value.driversName=r),center:"",disabled:"",clearable:"",label:"真实姓名",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),v.value?(d(),o(b,{key:9,style:{width:"60%",margin:"1% auto"},"after-read":le},{default:n(()=>[c(m,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[g(" 拍摄您的驾驶证-主页-以自动识别 ")]),_:1})]),_:1})):u("",!0),v.value?(d(),o(i,{key:10,modelValue:a.value.driversLicenseNo,"onUpdate:modelValue":e[13]||(e[13]=r=>a.value.driversLicenseNo=r),center:"",disabled:"",clearable:"",label:"驾驶证号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),v.value?(d(),o(i,{key:11,modelValue:a.value.driversLicenseType,"onUpdate:modelValue":e[14]||(e[14]=r=>a.value.driversLicenseType=r),center:"",disabled:"",clearable:"",label:"准驾类型",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),v.value?(d(),o(b,{key:12,style:{width:"60%",margin:"1% auto"},"after-read":re},{default:n(()=>[c(m,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[g(" 拍摄您的行驶证-主页-以自动识别 ")]),_:1})]),_:1})):u("",!0),v.value?(d(),o(b,{key:13,style:{width:"60%",margin:"1% auto"},"after-read":te},{default:n(()=>[c(m,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[g(" 拍摄您的行驶证-副页-以自动识别 ")]),_:1})]),_:1})):u("",!0),v.value?(d(),o(i,{key:14,modelValue:a.value.driversPlateNo,"onUpdate:modelValue":e[15]||(e[15]=r=>a.value.driversPlateNo=r),center:"",disabled:"",clearable:"",label:"车牌号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),v.value?(d(),o(i,{key:15,modelValue:a.value.driversVehicleType,"onUpdate:modelValue":e[16]||(e[16]=r=>a.value.driversVehicleType=r),center:"",disabled:"",clearable:"",autosize:"",type:"textarea",label:"车型",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),v.value?(d(),o(i,{key:16,modelValue:a.value.driversExpireDate,"onUpdate:modelValue":e[17]||(e[17]=r=>a.value.driversExpireDate=r),center:"",disabled:"",clearable:"",label:"证照最早过期时间",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0)]),_:1}),N("p",null,[Be,N("a",{style:{color:"#5CA0FF"},onClick:e[18]||(e[18]=r=>w(R).push("/privacy"))},"隐私政策")]),N("div",Re,[c(m,{plain:"",block:"",type:"primary","native-type":"submit"},{default:n(()=>[g(" 注册 ")]),_:1})])]),_:1})])}}},je=Ee(Fe,[["__scopeId","data-v-903e8566"]]);export{je as default};
