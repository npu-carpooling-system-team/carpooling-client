import{j as le,k as y,w as se,o as d,l as O,b as m,a as n,n as f,s as l,p as b,F as te,d as C,c as o,q as v,v as u,m as $,x as re,y as ie,z as ne,B as de,D as oe,E as ue,U as ce,A as me}from"./.pnpm-cbfa755c.js";import{e as pe,v as A,b as F,a as ve,c as ge}from"./validatorUtil-14f1ba53.js";import{_ as V}from"./index-fe957e2a.js";import{_ as ye}from"./index-da0ba07d.js";const J=async c=>{const g=B(c.content,c.file.name),a=new FormData;return a.append("file",g),await V.post("/api/auth/register/ocr/idCard",a)},fe=async c=>{const g=B(c.content,c.file.name),a=new FormData;return a.append("file",g),await V.post("/api/auth/register/ocr/drivingLicense",a)},Z=async c=>{const g=B(c.content,c.file.name),a=new FormData;return a.append("file",g),await V.post("/api/auth/register/ocr/vehicleLicense",a)};function B(c,g){let a=c.split(","),w=a[0].match(/:(.*?);/)[1],k=window.atob(a[1]),h=k.length,L=new Uint8Array(h);for(;h--;)L[h]=k.charCodeAt(h);return new File([L],g,{type:w})}const M=c=>(re("data-v-84794edc"),c=c(),ie(),c),be={class:"register-form"},ke=M(()=>$("h3",{class:"title"},"西工大拼车平台——注册",-1)),he=M(()=>$("h5",null,"用户角色选择(可多选)",-1)),Ve={key:4},we=M(()=>$("a",null,"您确认注册则代表您认可我们的",-1)),_e={class:"submit-login-btn"},xe={__name:"UserRegister",setup(c){const g=le(),a=y({username:"",password:"",email:"",isDriver:!1,isPassenger:!1,driversPersonalId:"",driversName:"",driversLicenseNo:"",driversLicenseType:"",driversPlateNo:"",driversVehicleType:"",driversExpireDate:""}),w=y(!0),k=y({phone:"",code:""}),h=y(""),L=async()=>{if(!A(a.value.username)){l({type:"danger",message:"手机号格式不正确"});return}f({duration:0,forbidClick:!0,message:"请求验证码发送中"});const t={phone:a.value.username};try{const{data:e}=await V.post("/api/auth/sendsms",t);if(e.code!==null&&e.code===2e3){l({type:"success",message:"验证码已发送"}),h.value="300s",w.value=!1;let s=300;const r=setInterval(()=>{s--,h.value=s+"s",s===0&&(clearInterval(r),w.value=!0)},1e3)}else l({type:"danger",message:`验证码发送失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{b()}},_=y(!1),G=async()=>{if(k.value.phone=a.value.username,!F(k.value.code)||!A(k.value.phone)){l({type:"danger",message:"格式不正确"});return}f({duration:0,forbidClick:!0,message:"请求验证码验证中"});try{const{data:t}=await V.post("/api/auth/checksms",k.value);t.code!==null&&t.code===2e3?(l({type:"success",message:"验证码验证成功"}),_.value=!0):l({type:"danger",message:`验证码验证失败,${t.msg},请重试`})}catch(t){l({type:"danger",message:`服务器异常${t},请通知管理员`})}finally{b()}},x=y({mail:"",code:""}),P=y(!1),I=y(!0),T=y(""),j=async()=>{if(!/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(a.value.email)){l({type:"danger",message:"邮箱格式不正确"});return}f({duration:0,forbidClick:!0,message:"请求验证码发送中"});const t={email:a.value.email};try{const{data:e}=await V.post("/api/auth/sendmail",t);if(e.code!==null&&e.code===2e3){l({type:"success",message:"验证码已发送"}),T.value="300s",I.value=!1;let s=300;const r=setInterval(()=>{s--,T.value=s+"s",s===0&&(clearInterval(r),I.value=!1)},1e3)}else l({type:"danger",message:`验证码发送失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{b()}},q=async()=>{if(x.value.mail=a.value.email,!F(x.value.code)||/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(x.value.code)){l({type:"danger",message:"格式不正确"});return}f({duration:0,forbidClick:!0,message:"请求邮箱验证中"});try{const{data:t}=await V.post("/api/auth/checkmail",x.value);t.code!==null&&t.code===2e3?(l({type:"success",message:"邮箱验证成功"}),P.value=!0):l({type:"danger",message:`邮箱验证失败,${t.msg},请重试`})}catch(t){l({type:"danger",message:`服务器异常${t},请通知管理员`})}finally{b()}},E=y([]),p=y(!1),z=t=>(console.log(t.file.type),t.content.size>10*1024*1024?(l({type:"danger",message:"文件大小不能超过10M"}),!1):/image\/(png|jpg|jpeg|JPG|PNG)/.test(t.file.type)?!0:(l({type:"danger",message:"文件格式不正确"}),!1)),Y=async t=>{if(z(t)){f({duration:0,forbidClick:!0,message:"正在识别身份证"});try{const{data:e}=await J(t);if(e.code===2e3){const s=JSON.parse(e.data);if(s.data.face!==null){const r=s.data.face;if(r.warning.isCopy!==0||r.warning.isReshoot!==0){l({type:"danger",message:"识别到翻拍或复制。请识别原件身份证"});return}a.value.driversName=r.data.name,a.value.driversPersonalId=r.data.idNumber}else l({type:"danger",message:"身份证识别失败,请重试"})}else l({type:"danger",message:`身份证识别失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{b()}}},H=async t=>{if(z(t)){f({duration:0,forbidClick:!0,message:"正在识别身份证"});try{const{data:e}=await J(t);if(e.code===2e3){const s=JSON.parse(e.data);if(s.data.back!==null){const r=s.data.back;if(r.warning.isCopy!==0||r.warning.isReshoot!==0){l({type:"danger",message:"识别到翻拍或复制。请识别原件身份证"});return}r.data.validPeriod.split("-")[1]==="长期"?r.data.validPeriod="2999-12-31":a.value.driversExpireDate=r.data.validPeriod.split("-")[1].replace(/(\d{4})\.(\d{2})\.(\d{2})/,"$1-$2-$3")}else l({type:"danger",message:"请识别身份证反面"})}else l({type:"danger",message:`身份证识别失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{b()}}},K=async t=>{if(z(t))a.value.driversName===""&&l({type:"danger",message:"请先识别身份证信息"});else return;f({duration:0,forbidClick:!0,message:"正在识别驾驶证"});try{const{data:e}=await fe(t);if(e.code===2e3){const s=JSON.parse(e.data);if(s.data.face!==null){if(s.data.face.data.name!==a.value.driversName||s.data.face.data.licenseNumber!==a.value.driversPersonalId){l({type:"danger",message:"驾驶证与身份证所属人不一致,请更新材料"});return}a.value.driversLicenseNo=s.data.face.data.licenseNumber,a.value.driversLicenseType=s.data.face.data.approvedType;const r=s.data.face.data.validPeriod.split("至")[1];a.value.driversExpireDate===""?a.value.driversExpireDate=r:a.value.driversExpireDate=a.value.driversExpireDate>r?r:a.value.driversExpireDate}else l({type:"danger",message:"驾驶证识别失败,请重试"})}else l({type:"danger",message:`驾驶证识别失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{b()}},Q=async t=>{if(z(t)){f({duration:0,forbidClick:!0,message:"正在识别行驶证"});try{const{data:e}=await Z(t);if(e.code===2e3){const s=JSON.parse(e.data);if(s.data.face!==null){if(s.data.face.data.owner!==a.value.driversName){l({type:"danger",message:"行驶证与身份证所属人不一致或身份信息为空,请更新材料"});return}else s.data.face.data.useNature!=="非营运"&&l({type:"warning",message:"行驶证非营运,我们建议您更新材料"});a.value.driversPlateNo=s.data.face.data.licensePlateNumber,a.value.driversVehicleType=s.data.face.data.model+" "+s.data.face.data.vehicleType}}else l({type:"danger",message:"行驶证识别失败,请重试"})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{b()}}},W=async t=>{if(z(t)){f({duration:0,forbidClick:!0,message:"正在识别行驶证"});try{const{data:e}=await Z(t);if(e.code===2e3){const s=JSON.parse(e.data);if(s.data.back!==null){if(s.data.back.inspectionRecord==null){l({type:"danger",message:"行驶证未年检,请更新材料"});return}const r=s.data.back.inspectionRecord,S=/有效期至([\u4e00-\u9fa5]{2,4}\d{1,4}年\d{1,2}月)/g,D=r.match(S);if(D===null){l({type:"danger",message:"行驶证年检信息解析失败,请更新材料"});return}D.sort((R,i)=>{const ee=R.match(/\d{1,4}年\d{1,2}月/)[0],ae=i.match(/\d{1,4}年\d{1,2}月/)[0];return ee>ae?1:-1});const U=D[D.length-1].match(/\d{1,4}年\d{1,2}月/)[0].replace("年","-").replace("月","-01");a.value.driversExpireDate===""?a.value.driversExpireDate=U:a.value.driversExpireDate=a.value.driversExpireDate>U?U:a.value.driversExpireDate}}else l({type:"danger",message:"行驶证识别失败,请重试"})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{b()}}};se(E,t=>{p.value=!!t.includes("isDriver")});const X=async()=>{f({duration:0,forbidClick:!0,message:"正在提交注册信息,我们推荐您完成注册后及时绑定支付宝。"});try{if(E.value.indexOf("isDriver")!==-1?a.value.isDriver=!0:E.value.indexOf("isPassenger")!==-1&&(a.value.isPassenger=!0),!a.value.isDriver&&!a.value.isPassenger){l({type:"danger",message:"请选择用户角色"});return}if(a.value.isDriver&&(a.value.driversName===""||a.value.driversPersonalId===""||a.value.driversVehicleType===""||a.value.driversExpireDate===""||a.value.driversPlateNo==="")){l({type:"danger",message:"请完善司机信息"});return}if(!_.value){l({type:"danger",message:"请先完成手机号校验"});return}if(!P.value&&a.value.email!==""){l({type:"danger",message:"请先完成邮箱校验"});return}a.value.password=pe(a.value.password);const{data:t}=await V.post("/api/auth/register/user",a.value);t.code===2e3?(l({type:"success",message:"注册成功,请您登录"}),await g.push("/login")):l({type:"danger",message:t.message})}catch(t){l({type:"danger",message:`服务器异常${t},请通知管理员`})}finally{b()}};return(t,e)=>{const s=ne,r=de,S=oe,D=ue,N=ce,U=me,R=te;return d(),O("div",be,[ke,m(R,{onSubmit:e[19]||(e[19]=i=>X())},{default:n(()=>[m(U,{inset:"",style:{padding:"1%"}},{default:n(()=>[m(s,{modelValue:a.value.username,"onUpdate:modelValue":e[0]||(e[0]=i=>a.value.username=i),name:"手机号",label:"手机号",placeholder:"请输入手机号",type:"tel",clearable:"",rules:[{validator:C(A),message:"请输入正确的手机号码"}],disabled:_.value},null,8,["modelValue","rules","disabled"]),_.value?u("",!0):(d(),o(s,{key:0,modelValue:k.value.code,"onUpdate:modelValue":e[2]||(e[2]=i=>k.value.code=i),center:"",clearable:"",type:"digit",label:"短信验证码",placeholder:"请输入验证码",rules:[{validator:C(F),message:"应为4位数字"}]},{button:n(()=>[w.value?(d(),o(r,{key:0,size:"small",type:"primary",onClick:e[1]||(e[1]=i=>L()),disabled:_.value},{default:n(()=>[v(" 发送验证码 ")]),_:1},8,["disabled"])):w.value?u("",!0):(d(),o(r,{key:1,size:"small",type:"primary",disabled:"",loading:"","loading-text":h.value},null,8,["loading-text"]))]),_:1},8,["modelValue","rules"])),_.value?u("",!0):(d(),o(r,{key:1,plain:"",block:"",type:"primary",size:"small",style:{width:"40%",margin:"1% auto"},onClick:e[3]||(e[3]=i=>G())},{default:n(()=>[v("验证手机号码")]),_:1})),m(s,{modelValue:a.value.password,"onUpdate:modelValue":e[4]||(e[4]=i=>a.value.password=i),name:"密码",label:"密码",type:"password",placeholder:"请设置密码",autocomplete:"off",rules:[{validator:C(ve),message:"应为4-16位数字/字母/下划线"}]},null,8,["modelValue","rules"]),m(s,{modelValue:a.value.email,"onUpdate:modelValue":e[5]||(e[5]=i=>a.value.email=i),center:"",clearable:"",label:"邮箱",placeholder:"请输入邮箱(非强制)",disabled:P.value},null,8,["modelValue","disabled"]),P.value?u("",!0):(d(),o(s,{key:2,modelValue:x.value.code,"onUpdate:modelValue":e[7]||(e[7]=i=>x.value.code=i),center:"",clearable:"",type:"digit",label:"邮箱验证码",placeholder:"请输入验证码",rules:[{required:!1,validator:C(ge),message:"应为4位数字"}]},{button:n(()=>[I.value?(d(),o(r,{key:0,size:"small",type:"primary",onClick:e[6]||(e[6]=i=>j())},{default:n(()=>[v(" 发送验证码 ")]),_:1})):I.value?u("",!0):(d(),o(r,{key:1,size:"small",type:"primary",disabled:"",loading:"","loading-text":T.value},null,8,["loading-text"]))]),_:1},8,["modelValue","rules"])),P.value?u("",!0):(d(),o(r,{key:3,plain:"",block:"",type:"primary",size:"small",style:{width:"40%",margin:"1% auto"},onClick:e[8]||(e[8]=i=>q())},{default:n(()=>[v("验证邮箱")]),_:1})),he,m(D,{modelValue:E.value,"onUpdate:modelValue":e[9]||(e[9]=i=>E.value=i),direction:"horizontal",class:"checkbox-area"},{default:n(()=>[m(S,{name:"isPassenger"},{default:n(()=>[v("我希望拼车-乘客")]),_:1}),m(S,{name:"isDriver"},{default:n(()=>[v("我可以搭人-司机")]),_:1})]),_:1},8,["modelValue"]),p.value?(d(),O("h5",Ve,"请您补充以下信息")):u("",!0),p.value?(d(),o(N,{key:5,style:{width:"60%",margin:"0 auto"},"after-read":Y},{default:n(()=>[m(r,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[v(" 拍摄您的身份证-正面-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(d(),o(N,{key:6,style:{width:"60%",margin:"1% auto"},"after-read":H},{default:n(()=>[m(r,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[v(" 拍摄您的身份证-背面-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(d(),o(s,{key:7,modelValue:a.value.driversPersonalId,"onUpdate:modelValue":e[10]||(e[10]=i=>a.value.driversPersonalId=i),center:"",disabled:"",clearable:"",label:"身份证号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(d(),o(s,{key:8,modelValue:a.value.driversName,"onUpdate:modelValue":e[11]||(e[11]=i=>a.value.driversName=i),center:"",disabled:"",clearable:"",label:"真实姓名",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(d(),o(N,{key:9,style:{width:"60%",margin:"1% auto"},"after-read":K},{default:n(()=>[m(r,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[v(" 拍摄您的驾驶证-主页-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(d(),o(s,{key:10,modelValue:a.value.driversLicenseNo,"onUpdate:modelValue":e[12]||(e[12]=i=>a.value.driversLicenseNo=i),center:"",disabled:"",clearable:"",label:"驾驶证号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(d(),o(s,{key:11,modelValue:a.value.driversLicenseType,"onUpdate:modelValue":e[13]||(e[13]=i=>a.value.driversLicenseType=i),center:"",disabled:"",clearable:"",label:"准驾类型",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(d(),o(N,{key:12,style:{width:"60%",margin:"1% auto"},"after-read":Q},{default:n(()=>[m(r,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[v(" 拍摄您的行驶证-主页-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(d(),o(N,{key:13,style:{width:"60%",margin:"1% auto"},"after-read":W},{default:n(()=>[m(r,{plain:"",block:"",type:"primary",size:"small"},{default:n(()=>[v(" 拍摄您的行驶证-副页-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(d(),o(s,{key:14,modelValue:a.value.driversPlateNo,"onUpdate:modelValue":e[14]||(e[14]=i=>a.value.driversPlateNo=i),center:"",disabled:"",clearable:"",label:"车牌号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(d(),o(s,{key:15,modelValue:a.value.driversVehicleType,"onUpdate:modelValue":e[15]||(e[15]=i=>a.value.driversVehicleType=i),center:"",disabled:"",clearable:"",autosize:"",type:"textarea",label:"车型",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(d(),o(s,{key:16,modelValue:a.value.driversExpireDate,"onUpdate:modelValue":e[16]||(e[16]=i=>a.value.driversExpireDate=i),center:"",disabled:"",clearable:"",label:"证照最早过期时间",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0)]),_:1}),$("p",null,[we,$("a",{style:{color:"#5CA0FF"},onClick:e[17]||(e[17]=i=>C(g).push("/privacy"))},"隐私政策")]),$("div",_e,[m(r,{plain:"",block:"",type:"primary","native-type":"submit"},{default:n(()=>[v(" 注册 ")]),_:1}),m(r,{plain:"",block:"",type:"success",onClick:e[18]||(e[18]=i=>C(g).push("/login"))},{default:n(()=>[v(" 返回登录页 ")]),_:1})])]),_:1})])}}},Pe=ye(xe,[["__scopeId","data-v-84794edc"]]);export{Pe as default};
