import{G as ue,l as k,k as ce,H as ve,w as me,m as pe,J as ge,o as n,n as H,b as v,d as I,a as o,q as b,s as r,t as D,N as fe,F as ye,c as d,v as y,y as u,p as E,z as ke,A as he,D as be,B as De,K as Ce,L as Ve,U as _e,E as we}from"./.pnpm-c62345a9.js";import{e as xe,v as Z,b as G,a as Ne,c as Pe}from"./validatorUtil-b6911ca2.js";import{_ as x}from"./index-8e3cc4cb.js";import{_ as $e}from"./index-92aeb057.js";const K=async c=>{const h=j(c.content,c.file.name),m=new FormData;return m.append("file",h),await x.post("/api/auth/register/ocr/idCard",m)},Ie=async c=>{const h=j(c.content,c.file.name),m=new FormData;return m.append("file",h),await x.post("/api/auth/register/ocr/drivingLicense",m)},Q=async c=>{const h=j(c.content,c.file.name),m=new FormData;return m.append("file",h),await x.post("/api/auth/register/ocr/vehicleLicense",m)};function j(c,h){let m=c.split(","),f=m[0].match(/:(.*?);/)[1],a=window.atob(m[1]),C=a.length,V=new Uint8Array(C);for(;C--;)V[C]=a.charCodeAt(C);return new File([V],h,{type:f})}const Ee=ue("registerDtoCache",()=>({registerCache:k({registerDto:{username:"",password:"",email:"",isDriver:!1,isPassenger:!1,driversPersonalId:"",driversName:"",driversLicenseNo:"",driversLicenseType:"",driversPlateNo:"",driversVehicleType:"",driversExpireDate:""},checkSmsDisabled:!1,checkMailDisabled:!1,checkIdFront:!1,checkIdBack:!1,checkDriving:!1,checkCarFront:!1,checkCarBack:!1})}),{persist:{storage:sessionStorage,paths:["registerCache"],key:"registerCache"}});const q=c=>(ke("data-v-9a85a6b8"),c=c(),he(),c),Se={class:"register-form"},Le=q(()=>E("h3",{class:"title"},"西工大拼车平台——注册",-1)),ze=q(()=>E("h5",null,"用户角色选择(可多选)",-1)),Te={key:4},Ue=q(()=>E("a",null,"您确认注册则代表您认可我们的",-1)),Be={class:"submit-login-btn"},Fe={__name:"UserRegister",setup(c){const h=ce(),m=Ee(),{registerCache:f}=ve(m),a=k({username:"",password:"",email:"",isDriver:!1,isPassenger:!1,driversPersonalId:"",driversName:"",driversLicenseNo:"",driversLicenseType:"",driversPlateNo:"",driversVehicleType:"",driversExpireDate:""}),C=k(!0),V=k({phone:"",code:""}),M=k(""),W=async()=>{if(!Z(a.value.username)){r({type:"danger",message:"手机号格式不正确"});return}b({duration:0,forbidClick:!0,message:"请求验证码发送中"});const s={phone:a.value.username};try{const{data:e}=await x.post("/api/auth/sendsms",s);if(e.code!==null&&e.code===2e3){r({type:"success",message:"验证码已发送"}),M.value="300s",C.value=!1;let t=300;const i=setInterval(()=>{t--,M.value=t+"s",t===0&&(clearInterval(i),C.value=!0)},1e3)}else r({type:"danger",message:`验证码发送失败,${e.msg},请重试`})}catch(e){r({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{D()}},w=k(!1),X=async()=>{if(V.value.phone=a.value.username,!G(V.value.code)||!Z(V.value.phone)){r({type:"danger",message:"格式不正确"});return}b({duration:0,forbidClick:!0,message:"请求验证码验证中"});try{const{data:s}=await x.post("/api/auth/checksms",V.value);s.code!==null&&s.code===2e3?(r({type:"success",message:"验证码验证成功"}),w.value=!0):r({type:"danger",message:`验证码验证失败,${s.msg},请重试`})}catch(s){r({type:"danger",message:`服务器异常${s},请通知管理员`})}finally{D()}},$=k({mail:"",code:""}),N=k(!1),z=k(!0),A=k(""),ee=async()=>{if(!/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(a.value.email)){r({type:"danger",message:"邮箱格式不正确"});return}b({duration:0,forbidClick:!0,message:"请求验证码发送中"});const s={email:a.value.email};try{const{data:e}=await x.post("/api/auth/sendmail",s);if(e.code!==null&&e.code===2e3){r({type:"success",message:"验证码已发送"}),A.value="300s",z.value=!1;let t=300;const i=setInterval(()=>{t--,A.value=t+"s",t===0&&(clearInterval(i),z.value=!1)},1e3)}else r({type:"danger",message:`验证码发送失败,${e.msg},请重试`})}catch(e){r({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{D()}},ae=async()=>{if($.value.mail=a.value.email,!G($.value.code)||/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test($.value.code)){r({type:"danger",message:"格式不正确"});return}b({duration:0,forbidClick:!0,message:"请求邮箱验证中"});try{const{data:s}=await x.post("/api/auth/checkmail",$.value);s.code!==null&&s.code===2e3?(r({type:"success",message:"邮箱验证成功"}),N.value=!0):r({type:"danger",message:`邮箱验证失败,${s.msg},请重试`})}catch(s){r({type:"danger",message:`服务器异常${s},请通知管理员`})}finally{D()}},S=k([]),p=k(!1);let T=!1,U=!1,B=!1,F=!1,R=!1;const L=s=>s.content.size>10*1024*1024?(r({type:"danger",message:"文件大小不能超过10M"}),!1):/image\/(png|jpg|jpeg|JPG|PNG)/.test(s.file.type)?!0:(r({type:"danger",message:"文件格式不正确"}),!1),se=async s=>{if(L(s)){b({duration:0,forbidClick:!0,message:"正在识别身份证"});try{const{data:e}=await K(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.face!==null){const i=t.data.face;if(i.warning.isCopy!==0||i.warning.isReshoot!==0){r({type:"danger",message:"识别到翻拍或复制。请识别原件身份证"});return}a.value.driversName=i.data.name,a.value.driversPersonalId=i.data.idNumber,T=!0}else r({type:"danger",message:"身份证识别失败,请重试"})}else r({type:"danger",message:`身份证识别失败,${e.msg},请重试`})}catch(e){r({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{D()}}},re=async s=>{if(L(s)){b({duration:0,forbidClick:!0,message:"正在识别身份证"});try{const{data:e}=await K(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.back!==null){const i=t.data.back;if(i.warning.isCopy!==0||i.warning.isReshoot!==0){r({type:"danger",message:"识别到翻拍或复制。请识别原件身份证"});return}i.data.validPeriod.split("-")[1]==="长期"?i.data.validPeriod="2999-12-31":a.value.driversExpireDate=i.data.validPeriod.split("-")[1].replace(/(\d{4})\.(\d{2})\.(\d{2})/,"$1-$2-$3"),U=!0}else r({type:"danger",message:"请识别身份证反面"})}else r({type:"danger",message:`身份证识别失败,${e.msg},请重试`})}catch(e){r({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{D()}}},le=async s=>{if(L(s))a.value.driversName===""&&r({type:"danger",message:"请先识别身份证信息"});else return;b({duration:0,forbidClick:!0,message:"正在识别驾驶证"});try{const{data:e}=await Ie(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.face!==null){if(t.data.face.data.name!==a.value.driversName||t.data.face.data.licenseNumber!==a.value.driversPersonalId){r({type:"danger",message:"驾驶证与身份证所属人不一致,请更新材料"});return}a.value.driversLicenseNo=t.data.face.data.licenseNumber,a.value.driversLicenseType=t.data.face.data.approvedType;const i=t.data.face.data.validPeriod.split("至")[1];a.value.driversExpireDate===""?a.value.driversExpireDate=i:a.value.driversExpireDate=a.value.driversExpireDate>i?i:a.value.driversExpireDate,B=!0}else r({type:"danger",message:"驾驶证识别失败,请重试"})}else r({type:"danger",message:`驾驶证识别失败,${e.msg},请重试`})}catch(e){r({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{D()}},te=async s=>{if(L(s)){b({duration:0,forbidClick:!0,message:"正在识别行驶证"});try{const{data:e}=await Q(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.face!==null){if(t.data.face.data.owner!==a.value.driversName){r({type:"danger",message:"行驶证与身份证所属人不一致或身份信息为空,请更新材料"});return}else t.data.face.data.useNature!=="非营运"&&r({type:"warning",message:"行驶证非营运,我们建议您更新材料"});a.value.driversPlateNo=t.data.face.data.licensePlateNumber,a.value.driversVehicleType=t.data.face.data.model+" "+t.data.face.data.vehicleType,F=!0}}else r({type:"danger",message:"行驶证识别失败,请重试"})}catch(e){r({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{D()}}},ie=async s=>{if(L(s)){b({duration:0,forbidClick:!0,message:"正在识别行驶证"});try{const{data:e}=await Q(s);if(e.code===2e3){const t=JSON.parse(e.data);if(t.data.back!==null){if(t.data.back.data.inspectionRecord===null){r({type:"danger",message:"行驶证未年检,请更新材料"});return}const i=t.data.back.data.inspectionRecord,g=/有效期至(\d{1,4}年\d{1,2}月)/g,P=i.match(g);if(P===null){r({type:"danger",message:"行驶证年检信息解析失败,请更新材料"});return}P.sort((J,O)=>{const l=J.match(/\d{1,4}年\d{1,2}月/)[0],de=O.match(/\d{1,4}年\d{1,2}月/)[0];return l>de?1:-1});const _=P[P.length-1].match(/\d{1,4}年\d{1,2}月/)[0].replace("年","-").replace("月","-01");a.value.driversExpireDate===""?a.value.driversExpireDate=_:a.value.driversExpireDate=a.value.driversExpireDate>_?_:a.value.driversExpireDate,R=!0}}else r({type:"danger",message:"行驶证识别失败,请重试"})}catch(e){r({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{D()}}};me(S,s=>{p.value=!!s.includes("isDriver")});const ne=()=>a.value.isDriver&&(a.value.driversName===""||a.value.driversPersonalId===""||a.value.driversVehicleType===""||a.value.driversExpireDate===""||a.value.driversPlateNo==="")?(r({type:"danger",message:"请完善司机信息"}),!1):w.value?!N.value&&a.value.email!==""?(r({type:"danger",message:"请先完成邮箱校验"}),!1):a.value.isDriver&&(!T||!U||!B||!F||!R)?(r({type:"danger",message:"请先有关证照校验"}),!1):!0:(r({type:"danger",message:"请先完成手机号校验"}),!1),oe=async()=>{b({duration:0,forbidClick:!0,message:"正在提交注册信息,我们推荐您完成注册后及时绑定支付宝。"});try{if(S.value.indexOf("isDriver")!==-1?a.value.isDriver=!0:S.value.indexOf("isPassenger")!==-1&&(a.value.isPassenger=!0),!a.value.isDriver&&!a.value.isPassenger){r({type:"danger",message:"请选择用户角色"});return}if(!ne())return;a.value.password=xe(a.value.password);const{data:s}=await x.post("/api/auth/register/user",a.value);s.code===2e3?(r({type:"success",message:"注册成功,请您登录"}),await h.push("/login")):r({type:"danger",message:s.message})}catch(s){r({type:"danger",message:`服务器异常${s},请通知管理员`})}finally{D()}};return pe(()=>{(f.value.registerDto.isDriver||f.value.registerDto.isPassenger||f.value.registerDto.username!=="")&&(a.value=f.value.registerDto,w.value=f.value.checkSmsDisabled,N.value=f.value.checkMailDisabled,T=f.value.checkIdFront,U=f.value.checkIdBack,B=f.value.checkDriving,F=f.value.checkCarFront,R=f.value.checkCarBack)}),ge(()=>{m.$patch(s=>{s.registerCache.registerDto=a.value,s.registerCache.checkSmsDisabled=w.value,s.registerCache.checkMailDisabled=N.value,s.registerCache.checkIdFront=T,s.registerCache.checkIdBack=U,s.registerCache.checkDriving=B,s.registerCache.checkCarFront=F,s.registerCache.checkCarBack=R})}),(s,e)=>{const t=fe,i=be,g=De,P=Ce,Y=Ve,_=_e,J=we,O=ye;return n(),H("div",Se,[v(t,{title:"注册","left-text":"返回","left-arrow":"",onClickLeft:e[0]||(e[0]=l=>I(h).go(-1))}),Le,v(O,{onSubmit:e[19]||(e[19]=l=>oe())},{default:o(()=>[v(J,{inset:"",style:{padding:"1%"}},{default:o(()=>[v(i,{modelValue:a.value.username,"onUpdate:modelValue":e[1]||(e[1]=l=>a.value.username=l),name:"手机号",label:"手机号",placeholder:"请输入手机号",type:"tel",clearable:"",rules:[{validator:I(Z),message:"请输入正确的手机号码"}],disabled:w.value},null,8,["modelValue","rules","disabled"]),w.value?u("",!0):(n(),d(i,{key:0,modelValue:V.value.code,"onUpdate:modelValue":e[3]||(e[3]=l=>V.value.code=l),center:"",clearable:"",type:"digit",label:"短信验证码",placeholder:"请输入验证码",rules:[{validator:I(G),message:"应为4位数字"}]},{button:o(()=>[C.value?(n(),d(g,{key:0,size:"small",type:"primary",onClick:e[2]||(e[2]=l=>W()),disabled:w.value},{default:o(()=>[y(" 发送验证码 ")]),_:1},8,["disabled"])):C.value?u("",!0):(n(),d(g,{key:1,size:"small",type:"primary",disabled:"",loading:"","loading-text":M.value},null,8,["loading-text"]))]),_:1},8,["modelValue","rules"])),w.value?u("",!0):(n(),d(g,{key:1,plain:"",block:"",type:"primary",size:"small",style:{width:"40%",margin:"1% auto"},onClick:e[4]||(e[4]=l=>X())},{default:o(()=>[y("验证手机号码")]),_:1})),v(i,{modelValue:a.value.password,"onUpdate:modelValue":e[5]||(e[5]=l=>a.value.password=l),name:"密码",label:"密码",type:"password",placeholder:"请设置密码",autocomplete:"off",rules:[{validator:I(Ne),message:"应为4-16位数字/字母/下划线"}]},null,8,["modelValue","rules"]),v(i,{modelValue:a.value.email,"onUpdate:modelValue":e[6]||(e[6]=l=>a.value.email=l),center:"",clearable:"",label:"邮箱",placeholder:"请输入邮箱(非强制)",disabled:N.value},null,8,["modelValue","disabled"]),N.value?u("",!0):(n(),d(i,{key:2,modelValue:$.value.code,"onUpdate:modelValue":e[8]||(e[8]=l=>$.value.code=l),center:"",clearable:"",type:"digit",label:"邮箱验证码",placeholder:"请输入验证码",rules:[{required:!1,validator:I(Pe),message:"应为4位数字"}]},{button:o(()=>[z.value?(n(),d(g,{key:0,size:"small",type:"primary",onClick:e[7]||(e[7]=l=>ee())},{default:o(()=>[y(" 发送验证码 ")]),_:1})):z.value?u("",!0):(n(),d(g,{key:1,size:"small",type:"primary",disabled:"",loading:"","loading-text":A.value},null,8,["loading-text"]))]),_:1},8,["modelValue","rules"])),N.value?u("",!0):(n(),d(g,{key:3,plain:"",block:"",type:"primary",size:"small",style:{width:"40%",margin:"1% auto"},onClick:e[9]||(e[9]=l=>ae())},{default:o(()=>[y("验证邮箱")]),_:1})),ze,v(Y,{modelValue:S.value,"onUpdate:modelValue":e[10]||(e[10]=l=>S.value=l),direction:"horizontal",class:"checkbox-area"},{default:o(()=>[v(P,{name:"isPassenger"},{default:o(()=>[y("我希望拼车-乘客")]),_:1}),v(P,{name:"isDriver"},{default:o(()=>[y("我可以搭人-司机")]),_:1})]),_:1},8,["modelValue"]),p.value?(n(),H("h5",Te,"请您补充以下信息")):u("",!0),p.value?(n(),d(_,{key:5,style:{width:"60%",margin:"0 auto"},"after-read":se},{default:o(()=>[v(g,{plain:"",block:"",type:"primary",size:"small"},{default:o(()=>[y(" 拍摄您的身份证-正面-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(n(),d(_,{key:6,style:{width:"60%",margin:"1% auto"},"after-read":re},{default:o(()=>[v(g,{plain:"",block:"",type:"primary",size:"small"},{default:o(()=>[y(" 拍摄您的身份证-背面-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(n(),d(i,{key:7,modelValue:a.value.driversPersonalId,"onUpdate:modelValue":e[11]||(e[11]=l=>a.value.driversPersonalId=l),center:"",disabled:"",clearable:"",label:"身份证号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(n(),d(i,{key:8,modelValue:a.value.driversName,"onUpdate:modelValue":e[12]||(e[12]=l=>a.value.driversName=l),center:"",disabled:"",clearable:"",label:"真实姓名",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(n(),d(_,{key:9,style:{width:"60%",margin:"1% auto"},"after-read":le},{default:o(()=>[v(g,{plain:"",block:"",type:"primary",size:"small"},{default:o(()=>[y(" 拍摄您的驾驶证-主页-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(n(),d(i,{key:10,modelValue:a.value.driversLicenseNo,"onUpdate:modelValue":e[13]||(e[13]=l=>a.value.driversLicenseNo=l),center:"",disabled:"",clearable:"",label:"驾驶证号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(n(),d(i,{key:11,modelValue:a.value.driversLicenseType,"onUpdate:modelValue":e[14]||(e[14]=l=>a.value.driversLicenseType=l),center:"",disabled:"",clearable:"",label:"准驾类型",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(n(),d(_,{key:12,style:{width:"60%",margin:"1% auto"},"after-read":te},{default:o(()=>[v(g,{plain:"",block:"",type:"primary",size:"small"},{default:o(()=>[y(" 拍摄您的行驶证-主页-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(n(),d(_,{key:13,style:{width:"60%",margin:"1% auto"},"after-read":ie},{default:o(()=>[v(g,{plain:"",block:"",type:"primary",size:"small"},{default:o(()=>[y(" 拍摄您的行驶证-副页-以自动识别 ")]),_:1})]),_:1})):u("",!0),p.value?(n(),d(i,{key:14,modelValue:a.value.driversPlateNo,"onUpdate:modelValue":e[15]||(e[15]=l=>a.value.driversPlateNo=l),center:"",disabled:"",clearable:"",label:"车牌号",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(n(),d(i,{key:15,modelValue:a.value.driversVehicleType,"onUpdate:modelValue":e[16]||(e[16]=l=>a.value.driversVehicleType=l),center:"",disabled:"",clearable:"",autosize:"",type:"textarea",label:"车型",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0),p.value?(n(),d(i,{key:16,modelValue:a.value.driversExpireDate,"onUpdate:modelValue":e[17]||(e[17]=l=>a.value.driversExpireDate=l),center:"",disabled:"",clearable:"",label:"证照最早过期时间",placeholder:"该位置会被自动填充"},null,8,["modelValue"])):u("",!0)]),_:1}),E("p",null,[Ue,E("a",{style:{color:"#5CA0FF"},onClick:e[18]||(e[18]=l=>I(h).push("/privacy"))},"隐私政策")]),E("div",Be,[v(g,{plain:"",block:"",type:"primary","native-type":"submit"},{default:o(()=>[y(" 注册 ")]),_:1})])]),_:1})])}}},Oe=$e(Fe,[["__scopeId","data-v-9a85a6b8"]]);export{Oe as default};
