import{m as y,l as M,o as h,a as l,p as i,d as r,e as G,b as c,q as R,z as o,c as f,x as m,s as n,$ as P,N as F,D as Q,G as j,a0 as q,a1 as z,A as J,B as K,E as W}from"./.pnpm-2d117cc4.js";import{a as H,h as X,b as Y,c as Z,d as ee,e as ae,f as te}from"./index-9955c32b.js";import{_ as se}from"./index-a75880ea.js";import"./index-a31a7085.js";const ne=E=>(J("data-v-7c646ec1"),E=E(),K(),E),le={class:"btn-area"},oe={key:0},re={key:1,style:{"flex-direction":"row"}},ue={key:2},ie={key:4},de={key:6},ce={key:7},me=ne(()=>R("p",null,null,-1)),pe={key:8},ve={__name:"OrderDetail",setup(E){const d=y(""),C=M(),t=y({}),u=new Map;u.set("ORDER_FORCE_CLOSED","订单强制结束"),u.set("PRE_ORDER_REQUEST_SUBMITTED","订单已提交"),u.set("PRE_ORDER_REQUEST_PASSED","订单已通过"),u.set("PRE_DEPARTURE_USER_CANCELLED","订单已被用户取消"),u.set("DRIVING_USER_CONFIRM_DEPARTURE","用户确认发车"),u.set("ARRIVED_USER_UNPAID","用户未支付"),u.set("PAID_WAITING_CALLBACK","已支付，等待回调"),u.set("ORDER_NORMAL_CLOSED","订单正常结束");const p=async()=>{const a=await H(d.value);a!==null&&a.code===2e3?t.value=a.result.result:a!==null?n({type:"danger",message:`加载订单具体信息失败,${a.msg}`}):n({type:"danger",message:"加载订单具体信息失败,请检查网络连接"})},w=y(""),D=y(0);h(async()=>{d.value=C.currentRoute.value.query.orderId,await p(),w.value=JSON.parse(t.value.passingPoint).join(" "),document.getElementById("van-tab")!==null&&document.getElementById("van-tab").remove(),D.value=t.value.score===0?1:t.value.score});const S=async()=>{const a=[];t.value.passingPoint!==""&&a.push(JSON.parse(t.value.passingPoint)),await C.push("/main/driver/preview-map?departurePoint="+t.value.departurePoint+"&arrivePoint="+t.value.arrivePoint+"&passingPoint="+t.value.passingPoint+"&fromUrl=/main/carpooling/passenger-order")},O=async()=>{const a=await ee(d.value);a!==null&&a.code===2e3?(n({type:"success",message:"确认发车成功"}),await p()):a!==null?n({type:"danger",message:`确认发车失败,${a.msg}`}):n({type:"danger",message:"确认发车失败,请检查网络连接"})},A=async()=>{const a=new Date,e=new Date(t.value.departureTime);e.getTime()-a.getTime()>36e5||a.getTime()-e.getTime()>36e5?P({title:"提示",message:"当前时间与出发时间相差较大,是否确认发车",confirmButtonText:"确认发车",cancelButtonText:"取消",confirmButtonColor:"#f00",showCancelButton:!0}).then(async()=>{await O()}).catch(()=>{n({type:"primary",message:"您已放弃确认发车"})}):await O()},T=async()=>{const a=await ae();if(a!==null&&a.code===2e3){const e=a.result.userCancelTimes;if(e>=3)P({title:"提示",message:`您本年度已经取消了${e}次订单,本次若强制取消订单将会直接进入收费流程`,confirmButtonText:"确认取消",cancelButtonText:"取消",confirmButtonColor:"#f00",showCancelButton:!0}).then(()=>!0).catch(()=>(n({type:"warning",message:"您已放弃取消订单"}),!1));else if(e!==0)return n({type:"warning",message:`您在半年内一共取消了${e}次订单,本次可直接取消`}),!0;return!0}else if(a!==null)return n({type:"danger",message:`获取取消次数失败,${a.msg}`}),!1;return n({type:"danger",message:"获取取消次数失败,请检查网络连接"}),!1},V=async a=>{const e=await te(a);e!==null&&e.code===2e3?(n({type:"success",message:"取消订单成功"}),await p()):e!==null?n({type:"danger",message:`取消订单失败,${e.msg}`}):n({type:"danger",message:"取消订单失败,请检查网络连接"})},U=async()=>{await T()&&await V(d.value)},I=async()=>{const a=await X(d.value);a!==null&&a.code===2e3?(n({type:"success",message:"确认到达成功"}),await p()):a!==null?n({type:"danger",message:`确认到达失败,${a.msg}`}):n({type:"danger",message:"确认到达失败,请检查网络连接"})},v=y(!1),N=async a=>{if(a.name==="支付宝支付")try{const e=await Y(d.value);e!==null&&e.code===2e3?(v.value=!1,document.write(e.payUrl)):e!==null?n({type:"danger",message:`支付失败,${e.msg}`}):n({type:"danger",message:"支付失败,请检查网络连接"})}catch(e){console.log(e)}finally{v.value=!1,await p()}else n({type:"danger",message:"暂不支持该支付方式"})},k=[{name:"支付宝支付"}],B=async()=>{const a=await Z(d.value,D.value);a!==null&&a.code===2e3?(n({type:"success",message:"评分成功"}),await p()):a!==null?n({type:"danger",message:`评分失败,${a.msg}`}):n({type:"danger",message:"评分失败,请检查网络连接"})};return(a,e)=>{const L=F,_=W,g=Q,$=j,b=q,x=z;return l(),i("div",null,[r(L,{title:"订单详情","left-text":"返回","left-arrow":"",onClickLeft:e[0]||(e[0]=s=>G(C).go(-1))}),r($,{inset:""},{default:c(()=>[r(_,{readonly:"",modelValue:t.value.departurePoint,"onUpdate:modelValue":e[1]||(e[1]=s=>t.value.departurePoint=s),name:"出发地",label:"出发地"},null,8,["modelValue"]),r(_,{readonly:"",modelValue:t.value.arrivePoint,"onUpdate:modelValue":e[2]||(e[2]=s=>t.value.arrivePoint=s),name:"到达地",label:"到达地"},null,8,["modelValue"]),r(_,{readonly:"",modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=s=>w.value=s),name:"途径地",label:"途径地"},null,8,["modelValue"]),r(g,{plain:"",block:"",type:"primary",size:"small",style:{width:"40%",margin:"2% auto"},onClick:e[4]||(e[4]=s=>S())},{default:c(()=>[m(" 预览行程路线 ")]),_:1}),r(_,{readonly:"",modelValue:t.value.departureTime,"onUpdate:modelValue":e[5]||(e[5]=s=>t.value.departureTime=s),name:"出发时间",label:"出发时间"},null,8,["modelValue"]),r(_,{readonly:"",modelValue:t.value.arriveTime,"onUpdate:modelValue":e[6]||(e[6]=s=>t.value.arriveTime=s),name:"到达时间",label:"到达时间"},null,8,["modelValue"]),t.value.status==="ORDER_NORMAL_CLOSED"?(l(),f(_,{key:0,readonly:"",modelValue:t.value.score,"onUpdate:modelValue":e[7]||(e[7]=s=>t.value.score=s),name:"行程评分",label:"本次行程评分"},null,8,["modelValue"])):o("",!0)]),_:1}),R("div",le,[t.value.status==="PRE_ORDER_REQUEST_SUBMITTED"?(l(),i("div",oe,"正在等待司机确认")):o("",!0),t.value.status==="PRE_ORDER_REQUEST_PASSED"?(l(),i("div",re,[r(g,{plain:"",type:"success",onClick:e[8]||(e[8]=s=>A())},{default:c(()=>[m(" 确认发车 ")]),_:1}),r(g,{plain:"",type:"danger",onClick:e[9]||(e[9]=s=>U())},{default:c(()=>[m(" 取消行程 ")]),_:1})])):o("",!0),t.value.status==="PRE_DEPARTURE_USER_CANCELLED"?(l(),i("div",ue,"订单已被用户取消")):o("",!0),t.value.status==="DRIVING_USER_CONFIRM_DEPARTURE"?(l(),f(g,{key:3,plain:"",type:"success",onClick:e[10]||(e[10]=s=>I())},{default:c(()=>[m(" 确认到达 ")]),_:1})):o("",!0),t.value.status==="ARRIVED_USER_UNPAID"?(l(),i("div",ie,"请您支付订单")):o("",!0),t.value.status==="ARRIVED_USER_UNPAID"?(l(),f(g,{key:5,plain:"",onClick:e[11]||(e[11]=s=>v.value=!0),type:"success"},{default:c(()=>[m(" 开始支付 ")]),_:1})):o("",!0),t.value.status==="PAID_WAITING_CALLBACK"?(l(),i("div",de,"已发起支付，正在等待回调")):o("",!0),t.value.status==="ORDER_NORMAL_CLOSED"&&t.value.score==="0"?(l(),i("div",ce,[m(" 订单正常结束,请为本次行程评分 "),me])):o("",!0),t.value.status==="ORDER_NORMAL_CLOSED"&&t.value.score!=="0"?(l(),i("div",pe," 订单正常结束,您已经给出评分 ")):o("",!0),R("div",null,[R("div",null,[t.value.status==="ORDER_NORMAL_CLOSED"?(l(),f(b,{key:0,modelValue:D.value,"onUpdate:modelValue":e[12]||(e[12]=s=>D.value=s),color:"#ffd21e","void-icon":"star"},null,8,["modelValue"])):o("",!0)]),R("div",null,[t.value.status==="ORDER_NORMAL_CLOSED"&&t.value.score==="0"?(l(),f(g,{key:0,plain:"",onClick:e[13]||(e[13]=s=>B())},{default:c(()=>[m(" 确认提交评分 ")]),_:1})):o("",!0)])])]),r(x,{show:v.value,"onUpdate:show":e[14]||(e[14]=s=>v.value=s),actions:k,"cancel-text":"取消","close-on-click-action":"",onCancel:e[15]||(e[15]=s=>v.value=!1),description:"请选择支付方式",onSelect:N},null,8,["show"])])}}},Re=se(ve,[["__scopeId","data-v-7c646ec1"]]);export{Re as default};
