import{l as T,m as v,o as A,h as y,a as p,n as N,p as r,d as t,b as s,s as l,q as k,t as x,F as z,v as _,x as E,e as C,c as f,y as P,z as R,A as j,I as q,B as G,D as M,E as H}from"./.pnpm-33e9fd8e.js";import{_ as V}from"./index-85061a81.js";import{e as J}from"./jsencrypt-443c2eff.js";import{v as K,a as O,b as Q}from"./validatorUtil-fa8d24ca.js";import{_ as W}from"./index-6a793670.js";const X=""+new URL("alipayLogo-e4ca2d5f.png",import.meta.url).href;const F=m=>(R("data-v-e315df18"),m=m(),j(),m),Y={class:"login-box"},Z=F(()=>r("h1",{style:{"margin-top":"10%"}},"西工大拼车平台",-1)),ee={class:"icon-box"},ae={class:"form-box",id:"form-box"},oe=F(()=>r("div",{style:{height:"5%"}},null,-1)),te={class:"submit-login-btn"},se={__name:"UserLogin",setup(m){const c=T(),a=v({username:"",password:"",code:""}),d=v(!0),$=()=>{l({type:"danger",message:"表单校验未通过,请检查输入"});const n=document.getElementById("form-box");n.style.height="50%"},L=async()=>{k({duration:0,forbidClick:!0,message:"登录中"});const n={username:a.value.username,password:J(a.value.password)};try{y.remove("token");const{data:e}=await V.post("/api/auth/login/password",n);e.code!==null&&e.code===2e3?(y.set("token",e.result.token),await c.push("/main/home")):l({type:"danger",message:"用户名密码登录未通过,请检查输入"})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{x()}},g=v(!0),h=v(""),I=async()=>{k({duration:0,forbidClick:!0,message:"请求验证码发送中"});const n={phone:a.value.username};try{const{data:e}=await V.post("/api/auth/sendsms",n);if(e.code!==null&&e.code===2e3){l({type:"success",message:"验证码已发送"}),h.value="300s",g.value=!1;let u=300;const i=setInterval(()=>{u--,h.value=u+"s",u===0&&(clearInterval(i),g.value=!0)},1e3)}else l({type:"danger",message:`验证码发送失败,${e.msg},请重试`})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{x()}},B=async()=>{k({duration:0,forbidClick:!0,message:"登录中"});const n={phone:a.value.username,code:a.value.code};try{const e=await V.post("/api/auth/login/phone",n);e.data.code!==null&&e.data.code===2e3?(y.set("token",e.data.result.token),await c.push("/main/home")):l({type:"danger",message:"用户名短信登录未通过,请检查输入"})}catch(e){l({type:"danger",message:`服务器异常${e},请通知管理员`})}finally{x()}},S=()=>{window.location.replace("https://openauth.alipaydev.com/oauth2/publicAppAuthorize.htm?app_id=2021000121691518&scope=auth_user&redirect_uri=https%3A%2F%2Fcarpooling-server.wangminan.me%2Fapi%2Fauth%2Flogin%2Foauth%2Fcallback")},U=async()=>{await c.push("/register")};return A(async()=>{y.get("token")!==void 0&&await c.push("/main/home")}),(n,e)=>{const u=q,i=G,b=M,w=H,D=z;return p(),N("div",Y,[Z,r("div",ee,[t(u,{round:"",width:"80%",height:"80%",src:"/carpooling.svg"})]),r("div",ae,[oe,t(D,{onSubmit:e[6]||(e[6]=o=>d.value?L():B()),onFailed:$},{default:s(()=>[t(i,{class:"login-type-choose-btn",style:{"margin-top":"0"},plain:"",block:"",type:"warning",onClick:e[0]||(e[0]=o=>d.value=!d.value)},{default:s(()=>[_(E(d.value?"切换到验证码登录":"切换到用户名密码登录"),1)]),_:1}),t(w,{style:{"margin-top":"5%"},inset:""},{default:s(()=>[t(b,{modelValue:a.value.username,"onUpdate:modelValue":e[1]||(e[1]=o=>a.value.username=o),name:"手机号",label:"手机号",placeholder:"请输入手机号",type:"tel",rules:[{validator:C(K),message:"请输入正确的手机号码"}]},null,8,["modelValue","rules"])]),_:1}),d.value?(p(),f(w,{key:0,inset:"",style:{"margin-top":"5%"}},{default:s(()=>[t(b,{modelValue:a.value.password,"onUpdate:modelValue":e[2]||(e[2]=o=>a.value.password=o),name:"密码",label:"密码",type:"password",placeholder:"请输入密码",autocomplete:"off",rules:[{validator:C(O),message:"应为4-16位数字/字母/下划线"}]},null,8,["modelValue","rules"])]),_:1})):(p(),f(w,{key:1,style:{"margin-top":"5%"},inset:""},{default:s(()=>[t(b,{modelValue:a.value.code,"onUpdate:modelValue":e[4]||(e[4]=o=>a.value.code=o),center:"",clearable:"",type:"digit",label:"短信验证码",placeholder:"请输入验证码",rules:[{validator:C(Q),message:"应为4位数字"}]},{button:s(()=>[g.value?(p(),f(i,{key:0,size:"small",type:"primary",onClick:e[3]||(e[3]=o=>I())},{default:s(()=>[_(" 发送验证码 ")]),_:1})):g.value?P("",!0):(p(),f(i,{key:1,size:"small",type:"primary",disabled:"",loading:"","loading-text":h.value},null,8,["loading-text"]))]),_:1},8,["modelValue","rules"])]),_:1})),r("div",te,[t(i,{plain:"",block:"",type:"primary","native-type":"submit"},{default:s(()=>[_(" 登录 ")]),_:1}),t(i,{plain:"",block:"",type:"success",onClick:e[5]||(e[5]=o=>U())},{default:s(()=>[_(" 新账号注册 ")]),_:1})])]),_:1}),r("img",{onClick:e[7]||(e[7]=o=>S()),class:"alipay-icon",src:X,alt:"支付宝登录"})])])}}},ue=W(se,[["__scopeId","data-v-e315df18"]]);export{ue as default};
